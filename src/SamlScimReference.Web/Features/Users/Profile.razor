@page "/"
@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using SamlScimReference.Web.Features.Users
@attribute [Authorize]
@inject UserProfileService ProfileService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>User Profile</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3><i class="bi bi-person-check-fill"></i> Login Successful</h3>
                </div>
                <div class="card-body">
                    <h4>Welcome, @displayName!</h4>
                    <p class="text-success"><i class="bi bi-check-circle-fill"></i> You have successfully logged in via SAML and are provisioned in the system.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>User Details (from SCIM)</h5>
                </div>
                <div class="card-body">
                    @if (userProfile != null)
                    {
                        <table class="table table-sm">
                            <tr>
                                <th>User ID:</th>
                                <td>@userProfile.Id</td>
                            </tr>
                            <tr>
                                <th>Username:</th>
                                <td>@userProfile.UserName</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td>@userProfile.Email</td>
                            </tr>
                            <tr>
                                <th>First Name:</th>
                                <td>@userProfile.GivenName</td>
                            </tr>
                            <tr>
                                <th>Last Name:</th>
                                <td>@userProfile.FamilyName</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    @if (userProfile.Active)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Inactive</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <th>Created:</th>
                                <td>@userProfile.CreatedAt.ToLocalTime().ToString("g")</td>
                            </tr>
                            <tr>
                                <th>Last Login:</th>
                                <td>@userProfile.LastLoginAt?.ToLocalTime().ToString("g")</td>
                            </tr>
                        </table>

                        @if (userProfile.Groups.Any())
                        {
                            <h6 class="mt-3">Group Memberships:</h6>
                            <ul>
                                @foreach (var group in userProfile.Groups)
                                {
                                    <li>@group</li>
                                }
                            </ul>
                        }
                    }
                    else
                    {
                        <p class="text-muted">Loading...</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Current SAML Claims</h5>
                </div>
                <div class="card-body">
                    @if (claims.Any())
                    {
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Claim Type</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var claim in claims)
                                {
                                    <tr>
                                        <td><small>@GetClaimTypeShortName(claim.Type)</small></td>
                                        <td><small>@claim.Value</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">No claims available</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserProfileDto? userProfile;
    private List<Claim> claims = new();
    private string displayName = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            claims = user.Claims.ToList();
            
            var emailClaim = user.FindFirst(ClaimTypes.Email) 
                ?? user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress")
                ?? user.FindFirst("email");

            if (emailClaim != null)
            {
                userProfile = await ProfileService.GetUserProfileAsync(emailClaim.Value);
                
                if (userProfile != null)
                {
                    displayName = !string.IsNullOrEmpty(userProfile.GivenName) && !string.IsNullOrEmpty(userProfile.FamilyName)
                        ? $"{userProfile.GivenName} {userProfile.FamilyName}"
                        : userProfile.UserName;
                }
            }
        }
    }

    private string GetClaimTypeShortName(string claimType)
    {
        // Simplify long claim URIs to just the last part
        if (claimType.Contains("/"))
        {
            return claimType.Split('/').Last();
        }
        return claimType;
    }
}
